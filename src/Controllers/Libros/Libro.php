<?phpnamespace Controllers\Libros;use Controllers\PublicController;use Dao\Cart\Cart as CartDao;use Views\Renderer;use Dao\Libros\Libros as LibrosDao;use Utilities\Site;class Libro extends PublicController{    private $viewData = [];    private int $libroId = 0;    private string $libroNombre = "";    private string $libroAutor = "";    private $stock = 0;    private string $libroImagen = "";    private string $libroDescripcion = "";    private float $libroPrecio = 0.0;        private function getBookInfo() {        if (isset($_GET["id"])) {            $this->libroId = intval($_GET["id"]);            $tmpDataFromDb = LibrosDao::getById($this->libroId);            if ($tmpDataFromDb) {                $this->libroId = $tmpDataFromDb["libroId"];                $this->libroNombre = $tmpDataFromDb["libroNombre"];                $this->libroAutor = $tmpDataFromDb["libroAutor"];                $this->libroImagen = $tmpDataFromDb["libroImgUrl"];                $this->libroDescripcion = $tmpDataFromDb["libroDescripcion"];                $this->libroPrecio = $tmpDataFromDb["libroPrecio"];                $this->stock = $tmpDataFromDb["libroStock"];            }        }    }        private function prepareView(){        $this->viewData["libros"] = LibrosDao::getAllActive(4);        $this->viewData["libroId"] = $this->libroId;        $this->viewData["libroNombre"] = $this->libroNombre;        $this->viewData["libroAutor"] = $this->libroAutor;        $this->viewData["libroImagen"] = $this->libroImagen;        $this->viewData["libroDescripcion"] = $this->libroDescripcion;        $this->viewData["libroPrecio"] = $this->libroPrecio;        $this->viewData["stock"] = $this->stock;                if ($this->viewData["stock"] == 0) {            $this->viewData["noStock"] = "disabled";        }    }    public function run () : void    {        $this->getBookInfo();        $this->prepareView();        $usercod = \Utilities\Security::getUserId();        if ($this->isPostBack()) {            if (\Utilities\Security::isLogged()) {                try {                    $crrctd = isset($_POST["cantidad"]) ? $_POST["cantidad"] : 0;                    $crrprc = isset($_POST["precio"]) ? $_POST["precio"] : 0;                    $crrfching = date("Y-m-d H:i:s");                    $libroId = isset($_POST["libroId"]) ? $_POST["libroId"] : 0;                    //obtener el stock del libro en la base de datos                    $stock = LibrosDao::getById($libroId);                    if ($stock["libroStock"] < $crrctd) {                        Site::redirectToWithMsg("index.php?page=Libros_Catalogo", "No hay suficiente stock para el producto seleccionado.");                    } else {                        CartDao::insertProduct($usercod, $libroId, $crrctd, $crrprc, $crrfching);                        Site::redirectToWithMsg("index.php?page=Libros_Libro&id=$libroId", "Producto agregado al carrito.");                    }                } catch (\Exception $ex) {                    Site::redirectToWithMsg("index.php?page=Libros_Libro&id=$libroId", "El producto ya esta en el carrito.");                }            } else {                Site::redirectToWithMsg("index.php?page=sec_login", "Inicie sesion para agregar productos.");            }        }        Renderer::render('libros/libro',$this->viewData);    }}